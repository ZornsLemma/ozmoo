digraph memory {
    graph [nodesep=2];
    forcelabels=true;
    node [shape=plaintext];

    # SFTODO: Rename "top" to "ram"?
    top [xlabel="Hardware memory map", label=<
    <table>
        <tr><td colspan="2">Hardware/ROM/OS RAM</td></tr>
        <!-- SFTODO: could label start of this chunk of memory vmap_first_ram_page -->
        <tr><td>Virtual memory cache<br/>(vmap_max_entries<br/>512-byte blocks)</td>
            <td>
                <table port="vmem">
                    <tr>
                        <td><i>VM cache index<br/>(implicit)</i></td>
                        <td><i>512-byte data block</i></td>
                    </tr>
                    <tr>
                        <td>vmap_max_entries-1</td>
                        <td>jim</td>
                    </tr>
                    <tr colspan="2"><td>..</td></tr>
                    <tr>
                        <td>1</td>
                        <td>wobble</td>
                    </tr>
                    <tr>
                        <td>0</td>
                        <td>baz</td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr><td colspan="2">Game dynamic memory</td></tr>
        <tr><td colspan="2">Z-machine stack</td></tr>
        <tr><td colspan="2">Ozmoo code/data</td></tr>
        <tr><td>vmap<br/>(vmap_max_entries<br/>16-bit words)</td>
            <td>
                <table>
                    <tr>
                        <td><i>VM cache index<br/>(implicit)</i></td>
                        <td><i>timestamp<br/>(5-7 bits)</i></td>
                        <td><i>Z-machine address<br/>high+mid bytes<br/>(9-11 bits)</i></td>
                    </tr>
                    <tr><td>vmap_max_entries-1</td><td port="xlastblock">$7e</td><td port="z004a">$004a</td></tr>
                    <tr><td>...</td><td>...</td></tr>
                    <tr><td>1</td><td port="xblock1">$2d</td><td port="z0182">$0182</td></tr>
                    <tr><td>0</td><td port="xblock0">$61</td><td port="z002c">$002c</td></tr>
                </table>
            </td>
        </tr>
        <tr><td colspan="2">Ozmoo code/data</td></tr>
        <tr><td colspan="2">OS RAM</td></tr>
    </table>>];

    zmachine [xlabel="Z-machine memory map", label=<
    <table border="0" cellspacing="0">
        <tr>
            <td></td>
            <td border="1">...</td>
        </tr>
        <tr>
            <td valign="bottom"><sub>$018400</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->wubble</td>
        </tr>
        <tr>
            <td port="z0182" valign="bottom"><sub>$018200</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->wobble</td>
        </tr>
        <tr>
            <td valign="bottom"><sub>$018000</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->wibble</td>
        </tr>
        <tr>
            <td></td>
            <td border="1">...</td>
        </tr>
        <tr>
            <td valign="bottom"><sub>$004c00</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->sheila</td>
        </tr>
        <tr>
            <td port="z004a" valign="bottom"><sub>$004a00</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->jim</td>
        </tr>
        <tr>
            <td valign="bottom"><sub>$004800</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->fred</td>
        </tr>
        <tr>
            <td></td>
            <td border="1">...</td>
        </tr>
        <tr>
            <td valign="bottom"><sub>$002e00</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->quux</td>
        </tr>
        <tr>
            <td port="z002c" valign="bottom"><sub>$002c00</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->baz</td>
        </tr>
        <tr>
            <td valign="bottom"><sub>$002a00</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->bar</td>
        </tr>
        <tr>
            <td></td>
            <td border="1">...</td>
        </tr>
        <tr>
            <td valign="bottom"><sub>$000000</sub></td>
            <td border="1" cellpadding="10"><!-- Z-code: -->foo</td>
        </tr>
    </table>>];

    {rank = same; top zmachine};

    # Get rid of these lines, since they don't route well?
    top:lastblock:e -> top:xlastblock:e [dir=none];
    top:block1:e -> top:xblock1:e [dir=none];
    top:block0:e -> top:xblock0:e [dir=none];

    top:z004a:e -> zmachine:z004a:sw;
    top:z002c:e -> zmachine:z002c:sw;
    top:z0182:e -> zmachine:z0182:sw;
}

# vi: sw=4 sts=4
